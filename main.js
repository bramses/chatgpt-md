/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var X=Object.defineProperty;var ve=Object.getOwnPropertyDescriptor;var $e=Object.getOwnPropertyNames;var be=Object.prototype.hasOwnProperty;var Ge=(o,e)=>{for(var t in e)X(o,t,{get:e[t],enumerable:!0})},ke=(o,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of $e(e))!be.call(o,n)&&n!==t&&X(o,n,{get:()=>e[n],enumerable:!(r=ve(e,n))||r.enumerable});return o};var He=o=>ke(X({},"__esModule",{value:!0}),o);var Ye={};Ge(Ye,{default:()=>q});module.exports=He(Ye);var C=require("obsidian");var L=require("obsidian");var T="ollama",u="openai",ne="add-comment-block",se="add-hr",ae="call-chatgpt-api",oe="stop-streaming",ie="move-to-chat",le="infer-title",ce="choose-chat-template",me="clear-chat",he=`I am sorry. There was an authorization issue with the external API (Status 401).
Please check your API key in the settings`,ge=`I am sorry. There was an issue reaching the network.
Please check your network connection.`,pe="I am sorry, your request looks wrong. Please check your URL or model name in the settings or frontmatter.",G="I am sorry, I could not answer your request because of an error, here is what went wrong:",Z="chatFolder",de="chatTemplateFolder",m=`

`,x=/---[\s\S]*?---/g,ue=/\[\[([^\][]+)\]\]/g,fe=/\[([^\]]+)\]\(([^()]+)\)/g,Ee=`=begin-chatgpt-md-comment${m}`,Ce="=end-chatgpt-md-comment",Te=0,Q=6,_e=4,N="YYYYMMDDhhmmss",Me="Failed to fetch",ee="__chatgpt_plugin",F=`<hr class="${ee}">`,_="role::",w="assistant",k="developer",Ae="system",g="user";var H=o=>{let t=(o.match(/```/g)||[]).length%2!==0;return t&&console.log("[ChatGPT MD] Unclosed code block detected"),t},Ve=o=>{let e=o.trim().toLowerCase(),r=[g,w,k].find(n=>e.includes(n));if(r)return r;throw new Error(`Failed to extract role from input: "${o}"`)},Se=o=>{try{if(!o.includes(_))return{role:g,content:o};let[e,...t]=o.split(_)[1].split(`
`);return{role:Ve(e),content:t.join(`
`).trim()}}catch(e){throw new Error(`Failed to extract role and message: ${e}`)}},we=o=>{try{let e=/=begin-chatgpt-md-comment[\s\S]*?=end-chatgpt-md-comment/g;return o.replace(e,"")}catch(e){throw new Error("Error removing comments from messages"+e)}},Ue=o=>{let e=o.replace(/[-/\\^$*+?.()|[\]{}]/g,"\\$&").replace("YYYY","\\d{4}").replace("MM","\\d{2}").replace("DD","\\d{2}").replace("hh","\\d{2}").replace("mm","\\d{2}").replace("ss","\\d{2}");return new RegExp(`^${e}$`)},Ie=(o="",e)=>(o==null?void 0:o.length)==e.length&&Ue(e).test(o),te=o=>o===0?"":o>6?"#".repeat(6)+" ":"#".repeat(o)+" ",D=(o,e,t)=>`${m}${F}${m}${o}${_}${e}${t?`<span style="font-size: small;"> (${t})</span>`:""}${m}`,ye=o=>{let t=o.replace(/^---\n/,"").replace(/\n---$/,"").split(`
`),r={};for(let n of t){if(!n.trim())continue;let[s,...a]=n.split(":"),i=a.join(":").trim();i.startsWith("[")&&i.endsWith("]")?r[s.trim()]=i.slice(1,-1).split(",").map(l=>{let c=l.trim();return c.startsWith("'")&&c.endsWith("'")?c.slice(1,-1):c}):i==="true"?r[s.trim()]=!0:i==="false"?r[s.trim()]=!1:i==="null"?r[s.trim()]=null:isNaN(Number(i))?r[s.trim()]=i:r[s.trim()]=Number(i)}return r},Oe=o=>o.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),Pe=o=>o?o.split(F):[],Ne=o=>(o=o&&o.replace(x,"").trim(),o);var V=class{constructor(){this.abortController=null;this.stopStreaming=()=>{if(L.Platform.isMobile){new L.Notice("[ChatGPT MD] Mobile not supported.");return}this.abortController&&(this.abortController.abort(),console.log("[ChatGPT MD] Stream aborted"),this.abortController=null)}}handleEditorTextUpdate(e,t,r){let n=e.posToOffset(r),s=e.cm;s.dispatch(s.state.update({changes:{from:n,to:n,insert:t}}));let a={line:r.line,ch:r.ch+t.length};return e.setCursor(a),a}insertAssistantHeader(e,t,r){let n=D(t,w,r);e.replaceRange(n,e.getCursor());let s=e.getCursor(),a={line:s.line,ch:s.ch+n.length};return e.setCursor(a),a}finalizeText(e,t,r,n){let s=H(t)?t+"\n```":t,a=e.getCursor();e.replaceRange(s,{line:r.line,ch:r.ch},a);let i={line:r.line,ch:r.ch+s.length};return e.setCursor(i),n?new L.Notice("[ChatGPT MD] Text pasted at cursor may leave artifacts. Please remove them manually. ChatGPT MD cannot safely remove text when pasting at cursor."):e.replaceRange("",i,{line:1/0,ch:1/0}),s}async stream(e,t,r,n,s,a,i){let l="",c;try{console.log('[ChatGPT MD] "stream"',r),c=this.insertAssistantHeader(e,i,r.model),this.abortController=new AbortController;let h=await fetch(t,{headers:n,method:"POST",body:JSON.stringify(r),signal:this.abortController.signal});if(h.status==401)return this.finalizeText(e,he,c,a);if(h.status==404)return this.finalizeText(e,`${pe}:${m}Model: ${r.model}${m}URL: ${t}`,c,a);if(!h.ok)throw new Error("Network response was not ok");if(!h.body)throw new Error("The response was empty");let I=h.body.getReader(),y=new TextDecoder;for(;;){let{done:O,value:$}=await I.read();if(O)break;let Fe=y.decode($,{stream:!0}).split(`
`);for(let b of Fe)if(b.trim()){if(s==u){if(!b.startsWith("data: "))continue;let S=b.slice(6);if(S==="[DONE]")return this.finalizeText(e,l,c,a);try{let R=JSON.parse(S).choices[0].delta.content;if(R){let Le=e.getCursor();this.handleEditorTextUpdate(e,R,Le),l+=R}}catch(P){console.error("Error parsing OpenAI JSON:",P)}}else if(s==T)try{let S=JSON.parse(b);if(S.done)return this.finalizeText(e,l,c,a);{let P=S.message.content;if(P){let R=e.getCursor();this.handleEditorTextUpdate(e,P,R),l+=P}}}catch(S){console.error("Error parsing Ollama JSON:",S)}}}return l}catch(h){return h.name==="AbortError"?(console.log("[ChatGPT MD] Stream aborted"),this.finalizeText(e,"Stream aborted",c,a)):h.message==Me?this.finalizeText(e,ge,c,a):(console.error("Stream error:",h),this.finalizeText(e,`${G}${m}${h}`,c,a))}finally{this.abortController=null}}};var d=require("obsidian");var f=require("obsidian");var U=class{constructor(e){this.streamManager=e;this.inferTitleFromMessages=async(e,t,r)=>{try{if(t.length<2)return new f.Notice("Not enough messages to infer title. Minimum 2 messages."),"";let n=`Infer title from the summary of the content of these messages. The title **cannot** contain any of the following characters: colon, back slash or forward slash. Just return the title. Write the title in ${r.inferTitleLanguage}. 
Messages:${m}${JSON.stringify(t)}`,s={...p,...r};return await this.callNonStreamingAPI(r.apiKey,[{role:g,content:n}],s)}catch(n){throw new f.Notice("[ChatGPT MD] Error inferring title from messages"),new Error("[ChatGPT MD] Error inferring title from messages"+n)}}}async callAIAPI(e,t={},r,n,s,a){let i={...p,...t};return t.stream&&n?this.callStreamingAPI(a,e,i,n,r,s):this.callNonStreamingAPI(a,e,i)}async inferTitle(e,t,r,n){if(!e.file)throw new Error("No active file found");console.log("[ChatGPT MD] auto inferring title from messages");let s=await this.inferTitleFromMessages(t.apiKey,r,t);s?(console.log(`[ChatGPT MD] automatically inferred title: ${s}. Changing file name...`),await n.writeInferredTitle(e,s)):new f.Notice("[ChatGPT MD] Could not infer title",5e3)}handleAPIError(e,t,r){throw e instanceof Object?e.error?(new f.Notice(`${r} :: ${e.error.message}`),new Error(JSON.stringify(e.error))):t.url!==p.url?(new f.Notice(`${r} calling specified url: ${t.url}`),new Error(`${r} calling specified url: ${t.url}`)):(new f.Notice(`${r} :: ${JSON.stringify(e)}`),new Error(JSON.stringify(e))):(new f.Notice(`${r} calling ${t.model}, see console for details`),new Error(`${r} see error: ${e}`))}createPayload(e,t){return{model:e.model,messages:t,max_completion_tokens:e.max_tokens,temperature:e.temperature,top_p:e.top_p,presence_penalty:e.presence_penalty,frequency_penalty:e.frequency_penalty,stream:e.stream,stop:e.stop,n:e.n}}async callStreamingAPI(e,t,r,n,s,a){try{let i=this.createPayload(r,t);return{fullstr:await this.streamManager.stream(n,r.url,i,{"Content-Type":"application/json",Authorization:`Bearer ${e}`},r.aiService,a,s),mode:"streaming"}}catch(i){return this.handleAPIError(i,r,"[ChatGPT MD] Stream = True Error"),{fullstr:`${G}${m}${i}`,mode:"streaming"}}}async callNonStreamingAPI(e,t,r){try{console.log('[ChatGPT MD] "no stream"',r),r.stream=!1;let n=this.createPayload(r,t),a=(await(0,f.requestUrl)({url:r.url,method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},contentType:"application/json",body:JSON.stringify(n),throw:!1})).json;if(a!=null&&a.error)throw new f.Notice(`[ChatGPT MD] Stream = False Error :: ${a.error.message}`),new Error(JSON.stringify(a.error));return a.choices[0].message.content}catch(n){this.handleAPIError(n,r,"[ChatGPT MD] Error")}}},p={aiService:u,frequency_penalty:.5,max_tokens:300,model:"gpt-4o-mini",n:1,presence_penalty:.5,stop:null,stream:!0,system_commands:null,tags:[],temperature:.3,title:"Untitled",top_p:1,url:"https://api.openai.com/v1/chat/completions"};var Y=`---
system_commands: ['I am a helpful assistant.']
temperature: ${p.temperature}
top_p: ${p.top_p}
max_tokens: ${p.max_tokens}
presence_penalty: ${p.presence_penalty}
frequency_penalty: ${p.frequency_penalty}
stream: ${p.stream}
stop: ${p.stop}
n: ${p.n}
model: ${p.model}
---`,De={apiKey:"default",defaultChatFrontmatter:Y,stream:!0,chatTemplateFolder:"ChatGPT_MD/templates",chatFolder:"ChatGPT_MD/chats",generateAtCursor:!1,autoInferTitle:!1,dateFormat:N,headingLevel:0,inferTitleLanguage:"English"};var B=class extends d.PluginSettingTab{constructor(e,t){super(e,t),this.plugin=t}display(){let{containerEl:e}=this;e.empty(),e.createEl("h2",{text:"Settings for ChatGPT MD: Keep tokens in mind! You can see if your text is longer than the token limit (4096) here:"}),e.createEl("a",{text:"https://platform.openai.com/tokenizer",href:"https://platform.openai.com/tokenizer"}),new d.Setting(e).setName("OpenAI API Key").setDesc("API Key for OpenAI").addText(t=>t.setPlaceholder("some-api-key").setValue(this.plugin.settings.apiKey).onChange(async r=>{this.plugin.settings.apiKey=r,await this.plugin.saveSettings()})),new d.Setting(e).setName("Default Chat Frontmatter").setDesc("Default frontmatter for new chat files. You can change/use all of the settings exposed by the OpenAI API here: https://platform.openai.com/docs/api-reference/chat/create").addTextArea(t=>t.setPlaceholder(Y).setValue(this.plugin.settings.defaultChatFrontmatter||Y).onChange(async r=>{this.plugin.settings.defaultChatFrontmatter=r,await this.plugin.saveSettings()})),new d.Setting(e).setName("Stream").setDesc("Stream responses from OpenAI").addToggle(t=>t.setValue(this.plugin.settings.stream).onChange(async r=>{this.plugin.settings.stream=r,await this.plugin.saveSettings()})),new d.Setting(e).setName("Chat Folder").setDesc("Path to folder for chat files").addText(t=>t.setValue(this.plugin.settings.chatFolder).onChange(async r=>{this.plugin.settings.chatFolder=r,await this.plugin.saveSettings()})),new d.Setting(e).setName("Chat Template Folder").setDesc("Path to folder for chat file templates").addText(t=>t.setPlaceholder("chat-templates").setValue(this.plugin.settings.chatTemplateFolder).onChange(async r=>{this.plugin.settings.chatTemplateFolder=r,await this.plugin.saveSettings()})),new d.Setting(e).setName("Generate at Cursor").setDesc("Generate text at cursor instead of end of file").addToggle(t=>t.setValue(this.plugin.settings.generateAtCursor).onChange(async r=>{this.plugin.settings.generateAtCursor=r,await this.plugin.saveSettings()})),new d.Setting(e).setName("Automatically Infer Title").setDesc("Automatically infer title after 4 messages have been exchanged").addToggle(t=>t.setValue(this.plugin.settings.autoInferTitle).onChange(async r=>{this.plugin.settings.autoInferTitle=r,await this.plugin.saveSettings()})),new d.Setting(e).setName("Date Format").setDesc("Date format for chat files. Valid date blocks are: YYYY, MM, DD, hh, mm, ss").addText(t=>t.setPlaceholder(N).setValue(this.plugin.settings.dateFormat).onChange(async r=>{this.plugin.settings.dateFormat=r,await this.plugin.saveSettings()})),new d.Setting(e).setName("Heading Level").setDesc(`Heading level for messages (example for heading level 2: '## ${_}${g}'). Valid heading levels are 0, 1, 2, 3, 4, 5, 6`).addText(t=>t.setValue(this.plugin.settings.headingLevel.toString()).onChange(async r=>{this.plugin.settings.headingLevel=parseInt(r),await this.plugin.saveSettings()})),new d.Setting(e).setName("Infer title language").setDesc("Language to use for title inference.").addDropdown(t=>{t.addOptions({English:"English",Japanese:"Japanese",Spanish:"Spanish",French:"French",German:"German",Chinese:"Chinese",Korean:"Korean",Italian:"Italian",Russian:"Russian"}),t.setValue(this.plugin.settings.inferTitleLanguage),t.onChange(async r=>{this.plugin.settings.inferTitleLanguage=r,await this.plugin.saveSettings()})})}};var E=require("obsidian");var v=require("obsidian"),K=class extends v.Modal{constructor(e,t,r){super(e),this.folderName=t,this.folderPath=r,this.result=!1,this.modalPromise=new Promise(n=>{this.resolveModalPromise=n})}onOpen(){let{contentEl:e}=this;e.createEl("h2",{text:`[ChatGPT MD] No ${this.folderName} folder found.`}),e.createEl("p",{text:`If you choose "Yes, Create", the plugin will automatically create a folder at: ${this.folderPath}. You can change this path in the plugin settings.`}),new v.Setting(e).addButton(t=>t.setButtonText("Yes, Create Folder").setTooltip("Create folder").setCta().onClick(()=>{this.result=!0,this.resolveModalPromise(this.result),this.close()})),new v.Setting(e).addButton(t=>t.setButtonText("No, I'll create it myself").setTooltip("Cancel").setCta().onClick(()=>{this.result=!1,this.resolveModalPromise(this.result),this.close()}))}waitForModalValue(){return this.modalPromise}onClose(){let{contentEl:e}=this;e.empty()}};var Re=async(o,e,t)=>{let r=new K(o,e,t);r.open();let n=await r.waitForModalValue();return n?(console.log("[ChatGPT MD] Creating folder"),await o.vault.createFolder(t)):console.log("[ChatGPT MD] Not creating folder"),n};var M=require("obsidian"),W=class extends M.SuggestModal{constructor(e,t,r){super(e),this.settings=t,this.titleDate=r}getFilesInChatFolder(){let e=this.app.vault.getAbstractFileByPath(this.settings.chatTemplateFolder);if(e!=null)return e.children;throw new M.Notice(`Error getting folder: ${this.settings.chatTemplateFolder}`),new Error(`Error getting folder: ${this.settings.chatTemplateFolder}`)}getSuggestions(e){let t=this.getFilesInChatFolder();return e==""?t.map(r=>({title:r.basename,file:r})):t.filter(r=>r.basename.toLowerCase().includes(e.toLowerCase())).map(r=>({title:r.basename,file:r}))}renderSuggestion(e,t){t.createEl("div",{text:e.title})}async onChooseSuggestion(e,t){new M.Notice(`Selected ${e.title}`);let r=await this.app.vault.read(e.file),n=`${this.titleDate} ${e.title}`,s=(0,M.normalizePath)(`${this.settings.chatFolder}/${n}.md`),a=1;for(;await this.app.vault.adapter.exists(s);)s=(0,M.normalizePath)(`${this.settings.chatFolder}/${n} (${a}).md`),a++;try{let i=await this.app.vault.create(s,r);await this.app.workspace.openLinkText(i.basename,"",!0)}catch(i){console.error(i)}}};var A=require("obsidian");var J={model:"gemma2",aiService:T,url:"http://localhost:11434",stream:!0},z=class{constructor(e){this.streamManager=e;this.inferTitleFromMessages=async(e,t)=>{try{if(e.length<2)return new A.Notice("Not enough messages to infer title. Minimum 2 messages."),"";let r=`Infer title from the summary of the content of these messages. The title **cannot** contain any of the following characters: colon, back slash or forward slash. Just return the title. Write the title in ${t.inferTitleLanguage}. 
Messages:${m}${JSON.stringify(e)}`,n={...J,...t};return await this.callNonStreamingAPI([{role:g,content:r}],n)}catch(r){throw new A.Notice("[ChatGPT MD] Error inferring title from messages"),new Error("[ChatGPT MD] Error inferring title from messages"+r)}}}async callAIAPI(e,t={},r,n,s){let a={...J,...t};return t.stream?this.callStreamingAPI(e,a,r,n,s):this.callNonStreamingAPI(e,a)}async inferTitle(e,t,r,n){if(!e.file)throw new Error("No active file found");console.log("[ChatGPT MD] auto inferring title from messages");let s=await this.inferTitleFromMessages(r,t);s?(console.log(`[ChatGPT MD] automatically inferred title: ${s}. Changing file name...`),await n.writeInferredTitle(e,s)):new A.Notice("[ChatGPT MD] Could not infer title",5e3)}async callStreamingAPI(e,t,r="",n,s=!1){try{return{fullstr:await this.streamManager.stream(n,`${t.url}/api/chat`,{model:t.model,messages:e,stream:!0},{"Content-Type":"application/json"},t.aiService,s,r),mode:"streaming"}}catch(a){throw this.handleError(a,t.model),new Error(`Issue calling custom API with streaming enabled:${a}`)}}async callNonStreamingAPI(e,t){try{console.log('[ChatGPT MD] "no stream"',t),t.stream=!1;let r=await(0,A.requestUrl)({url:`${t.url}/api/chat`,method:"POST",headers:{"Content-Type":"application/json"},contentType:"application/json",body:JSON.stringify({model:t.model,messages:e,stream:!1})}),n=JSON.parse(r.text);if(n.error)throw new Error(JSON.stringify(n.error));return n.message.content}catch(r){throw this.handleError(r,t.model),new Error(`Issue calling custom API with non-streaming enabled:${r}`)}}handleError(e,t){e instanceof Object&&e.error?new A.Notice(`[Custom API] Error :: ${e.error.message}`):new A.Notice(`Issue calling ${t}, see console for more details`)}};var re=(o,e)=>{switch(e){case u:return new U(o);case T:return new z(o);default:throw new Error("Unsupported API type")}},xe=(o,e)=>{let t=(o!=null?o:"").trim().toLowerCase(),r=(e!=null?e:"").trim().toLowerCase();if(r.includes("@")){let n=r.split("@")[0];if(["local",T].includes(n))return T;if(n===u)return u}return t.startsWith("http://localhost")||t.startsWith("http://127.0.0.1")?T:u};var j=class{constructor(e){this.app=e;this.getLinkedNoteContent=async e=>{try{let t=this.app.metadataCache.getFirstLinkpathDest(e,"");return t?await this.app.vault.read(t):null}catch(t){return console.error(`Error reading linked note: ${e}`,t),null}}}async writeInferredTitle(e,t){var a,i;let r=e.file;if(!r)throw new Error("No file is currently open");let n=(i=(a=r.parent)==null?void 0:a.path)!=null?i:"/",s=`${n}/${t}.md`;for(let l=1;await this.app.vault.adapter.exists(s);l++)s=`${n}/${t} (${l}).md`;try{await this.app.fileManager.renameFile(r,s)}catch(l){throw new E.Notice("[ChatGPT MD] Error writing inferred title to editor"),console.log("[ChatGPT MD] Error writing inferred title to editor",l),l}}async ensureFolderExists(e,t){return!await this.app.vault.adapter.exists(e)&&!await Re(this.app,t,e)?(new E.Notice(`[ChatGPT MD] No ${t} found. One must be created to use the plugin. Set one in settings and make sure it exists.`),!1):!0}addHorizontalRule(e,t,r){let n=`${m}<hr class="${ee}">${m}${te(r)}${_}${t}${m}`,s=e.getCursor();e.replaceRange(n,s),e.setCursor(s.line+n.split(`
`).length-1,0)}async createNewChatWithHighlightedText(e,t){try{let r=e.getSelection();if(!t.chatFolder||t.chatFolder.trim()===""){new E.Notice("[ChatGPT MD] No chat folder value found. Please set one in settings.");return}if(!await this.ensureFolderExists(t.chatFolder,Z))return;let s=`${this.getDate(new Date,t.dateFormat)}.md`,a=`${t.chatFolder}/${s}`,i=await this.app.vault.create(a,r);await this.app.workspace.openLinkText(i.basename,"",!0,{state:{mode:"source"}});let l=this.app.workspace.getActiveViewOfType(E.MarkdownView);if(!l){new E.Notice("No active markdown editor found.");return}l.editor.focus(),this.moveCursorToEnd(l.editor)}catch(r){console.error("[ChatGPT MD] Error in Create new chat with highlighted text",r),new E.Notice("[ChatGPT MD] Error in Create new chat with highlighted text, check console")}}appendMessage(e,t,r){let n=te(r),s=D(n,w),a=D(n,g);e.replaceRange(`${s}${t}${a}`,e.getCursor())}clearChat(e){try{let r=e.getValue().match(x);if(!r||r.length===0)throw new Error("No YAML frontmatter found in the document");let n=r[0];e.setValue(""),e.replaceRange(n,e.getCursor());let s={line:e.lastLine()+1,ch:0};e.setCursor(s)}catch(t){throw new Error(`Failed to clear conversation: ${t.message}`)}}moveCursorToEnd(e){try{let r={line:e.lastLine()+1,ch:0};e.setCursor(r)}catch(t){throw new Error("Error moving cursor to end of file"+t)}}findLinksInMessage(e){let t=[{regex:ue,fullMatchIndex:0,titleIndex:1},{regex:fe,fullMatchIndex:0,titleIndex:2}],r=[],n=new Set;for(let{regex:s,fullMatchIndex:a,titleIndex:i}of t)for(let l of e.matchAll(s)){let c=l[a],h=l[i];h&&!n.has(h)&&(r.push({link:c,title:h}),n.add(h))}return r}cleanMessagesFromNote(e){return Pe(Ne(e.getValue())).map(we)}async getMessagesFromEditor(e,t){let r=this.cleanMessagesFromNote(e);r=await Promise.all(r.map(async a=>{let i=this.findLinksInMessage(a);for(let l of i)try{let c=await this.getLinkedNoteContent(l.title);if(c){let h=new RegExp(`${m}${F}${m}#+ ${_}(?:${g}|${w}).*$`,"gm");c=c==null?void 0:c.replace(h,"").replace(x,""),a=a.replace(new RegExp(Oe(l.link),"g"),`${m}${l.title}${m}${c}${m}`)}else console.warn(`Error fetching linked note content for: ${l.link}`)}catch(c){console.error(c)}return a}));let n=r.map(Se),s=this.getFrontmatter(null,t,this.app);if(s.system_commands){let a=s.aiService===u?k:Ae;s.system_commands.forEach(i=>n.unshift({role:a,content:i}))}return{messages:r,messagesWithRole:n}}async createNewChatFromTemplate(e,t){let{chatFolder:r,chatTemplateFolder:n}=e;if(!r||!r.trim()){new E.Notice("[ChatGPT MD] No chat folder value found. Please set one in settings.");return}if(await this.ensureFolderExists(r,Z)){if(!n||!n.trim()){new E.Notice("[ChatGPT MD] No chat template folder value found. Please set one in settings.");return}await this.ensureFolderExists(n,de)&&new W(this.app,e,t).open()}}getDate(e,t=N){let r=e.getFullYear(),n=e.getMonth()+1,s=e.getDate(),a=e.getHours(),i=e.getMinutes(),l=e.getSeconds(),c=n.toString().padStart(2,"0"),h=s.toString().padStart(2,"0"),I=a.toString().padStart(2,"0"),y=i.toString().padStart(2,"0"),O=l.toString().padStart(2,"0");return t.replace("YYYY",r.toString()).replace("MM",c).replace("DD",h).replace("hh",I).replace("mm",y).replace("ss",O)}getFrontmatter(e,t,r){var h,I,y,O,$;let n=(e==null?void 0:e.file)||r.workspace.getActiveFile();if(!n)throw new Error("No active file found");let s=ye(t.defaultChatFrontmatter),a=((h=r.metadataCache.getFileCache(n))==null?void 0:h.frontmatter)||{},i={...s,...a};a.url||delete i.url;let l=xe(i.url,i.model),c=l==u?p:J;return{...c,...i,model:i.model.split("@")[1]||i.model,aiService:l,stream:(y=(I=i.stream)!=null?I:t.stream)!=null?y:c.stream,title:($=(O=e==null?void 0:e.file)==null?void 0:O.basename)!=null?$:c.title}}getHeadingPrefix(e){return e===Te?"":e>Q?"#".repeat(Q)+" ":"#".repeat(e)+" "}async processResponse(e,t,r){if(t.mode==="streaming"){let n=D(this.getHeadingPrefix(r.headingLevel),g);e.replaceRange(n,e.getCursor());let s=e.getCursor(),a={line:s.line,ch:s.ch+n.length};e.setCursor(a)}else{let n=t;H(n)&&(n=n+"\n```"),this.appendMessage(e,n,r.headingLevel)}}};var q=class extends C.Plugin{async onload(){this.statusBarItemEl=this.addStatusBarItem(),this.streamManager=new V,this.editorService=new j(this.app),this.settings=await Object.assign({},De,await this.loadData()),this.addCommand({id:ae,name:"Chat",icon:"message-circle",editorCallback:async(e,t)=>{var n;let r=this.editorService.getFrontmatter(t,this.settings,this.app);this.aiService=re(this.streamManager,r.aiService);try{let{messagesWithRole:s,messages:a}=await this.editorService.getMessagesFromEditor(e,this.settings);this.settings.generateAtCursor||this.editorService.moveCursorToEnd(e),C.Platform.isMobile?new C.Notice(`[ChatGPT MD] Calling ${r.model}`):this.updateStatusBar(`Calling ${r.model}`);let i=await this.aiService.callAIAPI(s,r,this.editorService.getHeadingPrefix(this.settings.headingLevel),e,this.settings.generateAtCursor,this.settings.apiKey);await this.editorService.processResponse(e,i,this.settings),this.settings.autoInferTitle&&Ie((n=t==null?void 0:t.file)==null?void 0:n.basename,this.settings.dateFormat)&&s.length>_e&&await this.aiService.inferTitle(t,r,a,this.editorService)}catch(s){C.Platform.isMobile&&new C.Notice(`[ChatGPT MD] Calling ${r.model}. `+s,9e3),console.log(s)}this.updateStatusBar("")}}),this.addCommand({id:se,name:"Add divider",icon:"minus",editorCallback:(e,t)=>{this.editorService.addHorizontalRule(e,g,this.settings.headingLevel)}}),this.addCommand({id:ne,name:"Add comment block",icon:"comment",editorCallback:(e,t)=>{let r=e.getCursor(),n=r.line,s=r.ch,a=`${Ee}${m}${Ce}`;e.replaceRange(a,r);let i={line:n+1,ch:s};e.setCursor(i)}}),this.addCommand({id:oe,name:"Stop streaming",icon:"octagon",callback:()=>{this.streamManager.stopStreaming()}}),this.addCommand({id:le,name:"Infer title",icon:"subtitles",editorCallback:async(e,t)=>{let r=this.editorService.getFrontmatter(t,this.settings,this.app);this.aiService=re(this.streamManager,r.aiService),this.updateStatusBar(`Calling ${r.model}`);let{messages:n}=await this.editorService.getMessagesFromEditor(e,this.settings);await this.aiService.inferTitle(t,this.settings,n,this.editorService),this.updateStatusBar("")}}),this.addCommand({id:ie,name:"Create new chat with highlighted text",icon:"highlighter",editorCallback:async(e,t)=>{try{await this.editorService.createNewChatWithHighlightedText(e,this.settings)}catch(r){console.error("[ChatGPT MD] Error in Create new chat with highlighted text",r),new C.Notice("[ChatGPT MD] Error in Create new chat with highlighted text, check console")}}}),this.addCommand({id:ce,name:"Create new chat from template",icon:"layout-template",callback:async()=>{this.settings.dateFormat&&await this.editorService.createNewChatFromTemplate(this.settings,this.editorService.getDate(new Date,this.settings.dateFormat)),new C.Notice("date format cannot be empty in your ChatGPT MD settings. You can choose something like YYYYMMDDhhmmss")}}),this.addCommand({id:me,name:"Clear chat (except frontmatter)",icon:"trash",editorCallback:async(e,t)=>{this.editorService.clearChat(e)}}),this.addSettingTab(new B(this.app,this))}async saveSettings(){await this.saveData(this.settings)}updateStatusBar(e){this.statusBarItemEl.setText(`[ChatGPT MD] ${e}`)}};
